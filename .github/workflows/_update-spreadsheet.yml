name: Update Spreadsheet (Reusable)

on:
  workflow_call:
    inputs:
      limit:
        description: "Limit number of cards (for testing)"
        required: false
        type: string
    outputs:
      should_retry:
        description: "Whether the workflow should be retried (403 error)"
        value: ${{ jobs.update.outputs.should_retry }}

jobs:
  update:
    runs-on: ubuntu-latest
    outputs:
      should_retry: ${{ steps.check_site.outputs.should_retry }}
    defaults:
      run:
        working-directory: kjersv
    steps:
      - name: Check site availability
        id: check_site
        working-directory: .
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://cardrush.media/pokemon/cards/)
          echo "HTTP Status: $STATUS"
          if [ "$STATUS" = "403" ]; then
            echo "Site returned 403 Forbidden"
            echo "should_retry=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "should_retry=false" >> $GITHUB_OUTPUT

      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: kjersv/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create credentials file
        run: echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > credentials.json

      - name: Create .env file
        run: |
          echo "SPREADSHEET_ID=${{ secrets.SPREADSHEET_ID }}" > .env
          echo "GOOGLE_CREDENTIALS_FILE=credentials.json" >> .env
          echo "LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" >> .env
          echo "LINE_USER_IDS=${{ secrets.LINE_USER_IDS }}" >> .env

      - name: Set timestamp
        id: ts
        run: echo "timestamp=$(TZ=Asia/Tokyo date +"%Y-%m-%d_%H%M%S")" >> $GITHUB_OUTPUT

      - name: Get card details
        run: |
          LIMIT_ARG=""
          if [ -n "${{ inputs.limit }}" ]; then
            LIMIT_ARG="--limit ${{ inputs.limit }}"
          fi
          ./scripts/card/get_all_card_details.py --fresh $LIMIT_ARG

      - name: Update spreadsheet and notify
        if: ${{ !inputs.limit }}
        run: |
          ./scripts/spreadsheet/update_spreadsheet.py --timestamp "${{ steps.ts.outputs.timestamp }}"
          ./scripts/notify/line_notify.py --timestamp "${{ steps.ts.outputs.timestamp }}"

      - name: Show diff (test mode - dry-run)
        if: ${{ inputs.limit }}
        run: |
          ./scripts/spreadsheet/update_spreadsheet.py --dry-run

      - name: Commit and push to submodule
        if: ${{ !inputs.limit }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/
          git diff --staged --quiet || git commit -m "Add diff $(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M:%S')"
          git pull --rebase origin develop
          git push origin HEAD:develop

      - name: Test notify and empty commit (dry-run)
        if: ${{ inputs.limit }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout develop
          git pull origin develop
          git commit --allow-empty -m "Test run completed $(TZ=Asia/Tokyo date +'%Y-%m-%d %H:%M:%S')"
          git push origin develop
          python3 -c "
          import os
          from dotenv import load_dotenv
          load_dotenv()
          from linebot.v3.messaging import Configuration, ApiClient, MessagingApi, PushMessageRequest, TextMessage
          config = Configuration(access_token=os.environ['LINE_CHANNEL_ACCESS_TOKEN'])
          with ApiClient(config) as client:
              api = MessagingApi(client)
              for user_id in os.environ['LINE_USER_IDS'].split(','):
                  api.push_message(PushMessageRequest(to=user_id.strip(), messages=[TextMessage(text='[TEST] daily-update dry-run completed')]))
          "
